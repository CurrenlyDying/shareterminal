#!/usr/bin/env bash
# shareterminal: start/join a shared tmux session via a shared socket.
# Works with Linux + macOS as long as tmux is installed.

set -euo pipefail
IFS=$'\n\t'

SOCKET_PATH="/tmp/shared_tmux"

if ! command -v tmux >/dev/null 2>&1; then
  echo "[ERROR] tmux is not installed or not in PATH."
  echo "        Install tmux (e.g., with your package manager) and try again."
  exit 1
fi

printf "Enter tmux session name [default: naier]: "
read -r SESSION_NAME
if [[ -z "${SESSION_NAME}" ]]; then
  SESSION_NAME="naier"
fi

echo "Using session name: '${SESSION_NAME}'"
echo "Socket path: ${SOCKET_PATH}"

SOCKET_DIR="$(dirname "${SOCKET_PATH}")"
if [[ ! -d "${SOCKET_DIR}" ]]; then
  echo "[INFO] Creating socket directory: ${SOCKET_DIR}"
  mkdir -p "${SOCKET_DIR}"
fi

# Warn when already in a tmux session
if [[ -n "${TMUX-}" ]]; then
  echo "[WARN] You are already inside a tmux session."
  echo "       Typing 'exit' in the LAST pane will kill the session for everyone."
  echo "       Use Ctrl-b then d, or type 'detach', to leave safely."
fi

session_exists=false
if tmux -S "${SOCKET_PATH}" has-session -t "${SESSION_NAME}" 2>/dev/null; then
  session_exists=true
fi

if [[ "${session_exists}" == false ]]; then
  echo "[INFO] Session '${SESSION_NAME}' does not exist â€” creating now..."
  tmux -S "${SOCKET_PATH}" new -s "${SESSION_NAME}" -d

  chmod 777 "${SOCKET_PATH}"
  echo "[INFO] Socket permissions set to 777 (any user on this machine can join)."
  echo "[INFO] Session created."
else
  echo "[INFO] Session '${SESSION_NAME}' already exists."
fi

# ðŸ”§ Force message display-time to 5s (5000 ms) for this tmux server and session
# Default is ~750 ms, which is very short. :contentReference[oaicite:1]{index=1}
tmux -S "${SOCKET_PATH}" set-option -g display-time 5000 || true
tmux -S "${SOCKET_PATH}" set-option -t "${SESSION_NAME}" display-time 5000 2>/dev/null || true

# ðŸ”Š Broadcast JOIN to all *existing* clients (the new one isn't attached yet)
existing_clients="$(tmux -S "${SOCKET_PATH}" list-clients -t "${SESSION_NAME}" -F '#{client_name}' 2>/dev/null || true)"

if [[ -n "${existing_clients}" ]]; then
  while IFS= read -r c; do
    [[ -z "$c" ]] && continue
    tmux -S "${SOCKET_PATH}" display-message -c "$c" "[JOIN] Another client is joining '${SESSION_NAME}'"
  done <<< "${existing_clients}"
fi

echo
echo "Inside tmux, remember:"
echo "  - To DETACH (leave session running):"
echo "        Ctrl-b then d      (native tmux detach)"
echo "        or: detach         (helper command installed by this script)"
echo "  - Avoid typing 'exit' in the last pane â€” that kills the shared session for everyone."
echo

echo "[INFO] Attaching to session '${SESSION_NAME}'..."
tmux -S "${SOCKET_PATH}" attach -t "${SESSION_NAME}"
